<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>clang-metatool: clang-metatool - A framework for reusing code in clang tools</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">clang-metatool
   </div>
   <div id="projectbrief">A framework for reusing code in clang tools</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">clang-metatool - A framework for reusing code in clang tools </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a href="https://travis-ci.org/bloomberg/clangmetatool"></a></p>
<h2>About clangmetatool</h2>
<p>When we first started writing clang tools, we realized that there is a lot of life cycle management that we had to repeat. In some cases, people advocate the usage of global variables to manage the life-cycle of that data, but that makes code reuse across tools even harder.</p>
<p>Additionally, we also learned that when writing a tool, it will be beneficial if the code is split in two phases. First a data collection phase, and later a post-processing phase that actually performed the bulk of the logic of the tool.</p>
<p>Essentially you will only need to write a class like:</p>
<div class="fragment"><div class="line">{C++}</div><div class="line">class MyTool {</div><div class="line">private:</div><div class="line">  SomeDataCollector collector1;</div><div class="line">  SomeOtherDataCollector collector2;</div><div class="line">public:</div><div class="line">  MyTool(clang::CompilerInstance* ci, clang::ast_matchers::MatchFinder *f)</div><div class="line">   :collector1(ci, f), collector2(ci, f) {</div><div class="line">   // the individual collectors will register their callbacks in their</div><div class="line">   // constructor, the tool doesn&#39;t really need to do anything else here.</div><div class="line">  }</div><div class="line">  void postProcessing</div><div class="line">  (std::map&lt;std::string, clang::tooling::Replacements&gt; &amp;replacementsMap) {</div><div class="line">   // use data from collector1 and collector2</div><div class="line">   // generate warnings and notices</div><div class="line">   // add replacements to replacementsMap</div><div class="line">  }</div><div class="line">};</div></div><!-- fragment --><p>And then you can use the <code><a class="el" href="classclangmetatool_1_1MetaToolFactory.html">clangmetatool::MetaToolFactory</a></code> combined with the <code><a class="el" href="classclangmetatool_1_1MetaTool.html">clangmetatool::MetaTool</a></code> in your tool's main function:</p>
<div class="fragment"><div class="line">{C++}</div><div class="line">int main(int argc, const char* argv[]) {</div><div class="line">  llvm::cl::OptionCategory MyToolCategory(&quot;my-tool options&quot;);</div><div class="line">  llvm::cl::extrahelp CommonHelp</div><div class="line">    (clang::tooling::CommonOptionsParser::HelpMessage);</div><div class="line">  clang::tooling::CommonOptionsParser</div><div class="line">    optionsParser(argc, argv, MyToolCategory);</div><div class="line">  clang::tooling::RefactoringTool tool(optionsParser.getCompilations(),</div><div class="line">                                       optionsParser.getSourcePathList());</div><div class="line">  clangmetatool::MetaToolFactory&lt; clangmetatool::MetaTool&lt;MyTool&gt; &gt;</div><div class="line">    raf(tool.getReplacements());</div><div class="line">  int r = tool.runAndSave(&amp;raf);</div><div class="line">  return r;</div><div class="line">}</div></div><!-- fragment --><p>One way in which our initial tools got hard to write and maintain was by trying to perform analysis or even replacements during the callbacks. It was not immediately obvious that this would lead to hard-to-maintain code. After we switched to the two-phase approach, we were able to reuse a lot more code across tools.</p>
<p>Fork me at <a href="https://github.com/bloomberg/clangmetatool/">github</a></p>
<h2>Infrastructure</h2>
<h3><code><a class="el" href="classclangmetatool_1_1MetaToolFactory.html">clangmetatool::MetaToolFactory</a></code></h3>
<p>This provides the boilerplate for a refactoring tool action, since you need a factory that passes the replacementsMap in to the frontend action class.</p>
<h3><code><a class="el" href="classclangmetatool_1_1MetaTool.html">clangmetatool::MetaTool</a></code></h3>
<p>This provides the boilerplate of a FrontendAction class that will perform data gathering and then run a post-processing phase that may do replacements. This simplifies the writing of the code into a constructor that registers preprocessor callbacks or ast matchers and a postprocessing phase.</p>
<h3>clangmetatool cmake module</h3>
<p>When building a clang tool you are expected to ship the builtin headers from the compiler with the tool, otherwise the tool will fail to find headers like stdarg.h. Clang expects to find the builtin headers relative to the absolute path of where the tool is installed. This cmake module will provide a function called <code>clangmetatool_install</code> which will handle all of that for you, example at <a href="skeleton/CMakeLists.txt">skeleton/CMakeLists.txt</a>.</p>
<h2>Reusable data types</h2>
<p>This defines types that can be used as building blocks, those will be in the <code><a class="el" href="namespaceclangmetatool_1_1types.html">clangmetatool::types</a></code> namespace.</p>
<h2>Reusable data collection</h2>
<p>Another part of this library consists of a number of "Data
Collectors". Those will be in the <code><a class="el" href="namespaceclangmetatool_1_1collectors.html">clangmetatool::collectors</a></code> namespace.</p>
<p>"Data Collector" is a "design pattern" for reusing code in clang tools. It works by having a class that takes the CompilerInstance object as well as the match finder to the constructor and registers all required callbacks in order to collect the data later.</p>
<p>The collector class will also have a "getData" method that will return the pointer to a struct with the data. The "getData" method should only be called in the 'post-processing' phase of the tool.</p>
<h2>Constant Propagation</h2>
<p>Another part of this consists of constant propagators to assist with analysis. Those will be in the <code><a class="el" href="namespaceclangmetatool_1_1propagation.html">clangmetatool::propagation</a></code> namespace.</p>
<p>More specifically, the current implementation provides propagation for the follwing types so that variables may be queried for their true values anywhere within the control-flow, so long as the value is deterministic:</p>
<ul>
<li>Constant C-style string propagator, which propagates constant strings through the control flow graph</li>
<li>Constant integer propagation which propagates integer values through the code considering references, pointers, const-ness of <code>int</code> &amp; <code>int</code>-like types</li>
</ul>
<p>This could be useful for various purposes but especially for identifing things like which database a function is actually calling out to, etc.</p>
<h3><code><a class="el" href="classclangmetatool_1_1propagation_1_1ConstantCStringPropagator.html">clangmetatool::propagation::ConstantCStringPropagator</a></code></h3>
<p>This provides infrastructure (utilizing <code>clangmetatool::propagation::ConstantPropagator</code> and <code>clangmetatool::propagation::PropagationVisitor</code>) to propagate constant C-style string values over the program. Resulting in the true value of a variable wherever the value is deterministic and "&lt;UNRESOLVED&gt;" anywhere else.</p>
<h4><code>clangmetatool::propagation::ConstantPropagator</code> and <code>clangmetatool::propagation::PropagationVisitor</code></h4>
<p>These two classes provide the boilerplate to create infrastructure to propagate constants of arbitrary types through the control flow graph of the program in such a way that anywhere the constant value of a variable would be deterministic one may query its value at that point.</p>
<p>These classes are private to the library, but additional propagators could be easily made using these facilities.</p>
<h2>Skeleton for a new project</h2>
<p>After you "git init" into an empty directory, copy the contents of the skeleton directory. To build that project, do something like:</p>
<div class="fragment"><div class="line">( mkdir -p build &amp;&amp; cd build/ &amp;&amp; \</div><div class="line">  cmake \</div><div class="line">  -DClang_DIR=/path/to/clang/ \</div><div class="line">  -Dclangmetatool_DIR=/path/to/clang/ \</div><div class="line">  -DCMAKE_BUILD_TYPE=Debug \</div><div class="line">  -DCMAKE_EXPORT_COMPILE_COMMANDS=1 \</div><div class="line">  .. )</div><div class="line">make -C build</div></div><!-- fragment --><h2>Building</h2>
<p>You need a full llvm+clang installation directory. Unfortunately, the Debian and Ubuntu packages <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=900440">are broken</a>, so you may need to work-around by creating some symlinks (see .travis.Dockerfile in this repo for an example).</p>
<div class="fragment"><div class="line">mkdir build</div><div class="line">cd build</div><div class="line">cmake -DClang_DIR=/path/to/clang/cmake ..</div><div class="line">make</div><div class="line">make install</div></div><!-- fragment --><h1>License and Copyright</h1>
<div class="fragment"><div class="line">// ----------------------------------------------------------------------------</div><div class="line">// Copyright 2018 Bloomberg Finance L.P.</div><div class="line">//</div><div class="line">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</div><div class="line">// you may not use this file except in compliance with the License.</div><div class="line">// You may obtain a copy of the License at</div><div class="line">//</div><div class="line">//     http://www.apache.org/licenses/LICENSE-2.0</div><div class="line">//</div><div class="line">// Unless required by applicable law or agreed to in writing, software</div><div class="line">// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</div><div class="line">// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</div><div class="line">// See the License for the specific language governing permissions and</div><div class="line">// limitations under the License.</div><div class="line">// ----------------------------- END-OF-FILE ----------------------------------</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
